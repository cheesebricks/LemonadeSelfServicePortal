<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detailed Flow Example: Press Release with Retry Mechanism</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        
        .container {
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 30px;
        }
        
        h2 {
            color: #34495e;
            margin-top: 40px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
            padding-left: 15px;
        }
        
        h3 {
            color: #2c3e50;
            margin-top: 25px;
            margin-bottom: 15px;
        }
        
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 6px;
            margin: 20px 0;
            overflow-x: auto;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .code-block pre {
            margin: 0;
        }
        
        .code-inline {
            background: #f1f3f4;
            color: #d73a49;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9em;
        }
        
        .highlight {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }
        
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }
        
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }
        
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .metric-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 20px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #3498db;
        }
        
        .metric-label {
            color: #6c757d;
            margin-top: 5px;
        }
        
        .flow-step {
            background: #f8f9fa;
            border-left: 4px solid #3498db;
            padding: 20px;
            margin: 20px 0;
            border-radius: 0 6px 6px 0;
        }
        
        .flow-step h4 {
            margin-top: 0;
            color: #2c3e50;
        }
        
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .comparison-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }
        
        .comparison-item h4 {
            margin-top: 0;
            color: #2c3e50;
        }
        
        .insight-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .insight-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 20px;
        }
        
        .insight-card h4 {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        
        @media (max-width: 768px) {
            .comparison {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Detailed Flow Example: Press Release with Retry Mechanism</h1>
        
        <p>This document shows a complete end-to-end flow of a Press Release request that fails on the first attempt and goes through the retry mechanism to achieve a passing TRS score.</p>

        <h2>User Request</h2>
        
        <div class="flow-step">
            <h4>Content Type</h4>
            <p><strong>Content Type:</strong> Press Release</p>
            <p><strong>Audience:</strong> Customers</p>
            <p><strong>Headline:</strong> "Lemonade Launches AI-Powered Pet Wellness Platform"</p>
            <p><strong>Key Message:</strong> "New platform provides instant health assessments and personalized care recommendations for pets"</p>
        </div>

        <h2>Stage 1: Request Processing & Policy Loading</h2>

        <h3>1.1 Policy Retrieval</h3>
        <div class="code-block">
<pre>// From src/policy.js - getPolicy('press_release')
{
  typeName: "PR / External",
  required: ["headline", "key_message", "audience", "locale"],
  corpus: { 
    file: 'corpus/press_release_corpus.json', 
    matchOn: ["audience", "locale"], 
    refs: 3 
  },
  traits: { witty: 0.2, empathetic: 0.5, clear: 1 },
  prefer: ["transparent pricing", "customers", "community"],
  bannedWords: ["sign up", "join us", "try now", "buy now", "emoji", "lol", "btw", "pls", "u", "thx"],
  intentLexicon: {},
  thresholds: { trs_pass: 80, trs_border: 72 }
}</pre>
        </div>

        <h3>1.2 Corpus Reference Selection</h3>
        <div class="code-block">
<pre>// From corpus/press_release_corpus.json - filtered by audience: "customer"
[
  {
    "id": "pr-update-customer-0001",
    "audience": "customer",
    "text": "We're rolling out faster claim decisions—powered by our AI—so more customers get paid in minutes, with zero paperwork.",
    "notes": "Customer-facing voice; short, benefit-led; no salesy hype."
  },
  {
    "id": "pr-update-customer-0002", 
    "audience": "customer",
    "text": "Pet Wellness is arriving in more EU countries, bringing simpler care and instant everything to your furry family.",
    "notes": "Friendly, plain-language customer announcement."
  },
  {
    "id": "pr-giveback-customer-0001",
    "audience": "customer", 
    "text": "Thanks to our community, we donated over $2M this year to nonprofits our customers care about—part of our annual Giveback.",
    "notes": "Customer‑friendly Giveback highlight."
  }
]</pre>
        </div>

        <h3>1.3 Lexicon Processing</h3>
        <div class="code-block">
<pre>// Preferred words from corpus + policy
preferred: [
  "AI-native", "automation", "instant", "instant everything", 
  "transparent pricing", "Giveback", "community", "zero paperwork", 
  "digital insurer", "transparent pricing", "customers", "community"
]

// Banned words from policy
banned: ["sign up", "join us", "try now", "buy now", "emoji", "lol", "btw", "pls", "u", "thx"]</pre>
        </div>

        <h2>Stage 2: Initial Generation</h2>

        <h3>2.1 Prompt Construction</h3>
        <div class="code-block">
<pre>// From src/prompts.js - genTemplate_generate()
{
  system: `You are a Lemonade copywriter. Voice: friendly, clear, compassionate; airy, concise.
Prefer contractions. Avoid emoji and filler. Avoid heavy insurance jargon; keep facts accurate.
TRAITS: witty(0.2), empathetic(0.5), clear(1).
LEXICON PREFER: AI-native, automation, instant, instant everything, transparent pricing, Giveback, community, zero paperwork, digital insurer, transparent pricing, customers, community
LEXICON AVOID: sign up, join us, try now, buy now, emoji, lol, btw, pls, u, thx
GUARDS:
- Return ONLY the final text. No prefaces like "Here is...", "Here's...", "Below is...", "Internal comms announcement:", "Press release:".
- No labels (Task:, Output:, Draft:).
- No code fences or markdown headings.`,

  user: `TASK: Press Release paragraph (lede/body).
AUDIENCE: customer
HEADLINE: Lemonade Launches AI-Powered Pet Wellness Platform
KEY MESSAGE: New platform provides instant health assessments and personalized care recommendations for pets
VOICE & EXAMPLES (for style, not content):
• pr-update-customer-0001 — We're rolling out faster claim decisions—powered by our AI—so more customers get paid in minutes, with zero paperwork.
• pr-update-customer-0002 — Pet Wellness is arriving in more EU countries, bringing simpler care and instant everything to your furry family.
• pr-giveback-customer-0001 — Thanks to our community, we donated over $2M this year to nonprofits our customers care about—part of our annual Giveback.
REQUIREMENTS:
- Factual tone; avoid consumer CTA language.
- CRITICAL: You MUST include the specific content from HEADLINE and KEY MESSAGE in your response.
- The response should directly address and incorporate the headline and key message details.
- Do NOT generate generic insurance content - focus on the specific announcement.
- Include at least 2-3 keywords from HEADLINE/KEY MESSAGE in the first sentence.
GUARDS:
- Return ONLY the final text. No prefaces like "Here is...", "Here's...", "Below is...", "Internal comms announcement:", "Press release:".
- No labels (Task:, Output:, Draft:).
- No code fences or markdown headings.
OUTPUT: Only the final text.`
}</pre>
        </div>

        <h3>2.2 LLM Response</h3>
        <div class="code-block">
<pre>// Generated content (FAILS TRS)
"Lemonade is excited to announce the launch of our new AI-powered pet wellness platform. This innovative solution brings instant health assessments and personalized care recommendations to pet owners everywhere."</pre>
        </div>

        <h3>2.3 TRS Scoring (Attempt #1)</h3>
        <div class="code-block">
<pre>// From src/guardrail.js - rulesScore()
{
  rules: 25, // -15 for insufficient keywords (only 1 match: "pet")
  lexicon: 20, // +20 for using preferred words like "AI-powered", "instant"
  critic: 28, // -12 for generic content and insufficient specificity
  total: 73, // BORDERLINE (below 80 threshold)
  verdict: "borderline"
}</pre>
        </div>

        <div class="highlight">
            <h4>Detailed TRS Breakdown:</h4>
            <ul>
                <li><strong>Rules (40 max):</strong> 25/40
                    <ul>
                        <li>Base: 40</li>
                        <li>Keyword penalty: -15 (only 1 keyword match, need 2-3)</li>
                        <li>Generic content penalty: 0 (no generic phrases detected)</li>
                    </ul>
                </li>
                <li><strong>Lexicon (20 max):</strong> 20/20
                    <ul>
                        <li>Preferred words: +20 (AI-powered, instant, personalized)</li>
                        <li>Banned words: 0 (no banned words used)</li>
                    </ul>
                </li>
                <li><strong>Critic (40 max):</strong> 28/40
                    <ul>
                        <li>Professional tone: +8</li>
                        <li>Content relevance: +8 (somewhat relevant but generic)</li>
                        <li>Specificity: +12 (lacks specific details from headline/key message)</li>
                    </ul>
                </li>
            </ul>
        </div>

        <h2>Stage 3: Retry Mechanism Activation</h2>

        <h3>3.1 Smart Feedback Generation</h3>
        <div class="code-block">
<pre>// From src/orchestrator.js - makeSmartFixes()
{
  fixes: [
    "Include more specific keywords from headline: 'AI-Powered Pet Wellness Platform'",
    "Incorporate key message details: 'instant health assessments' and 'personalized care recommendations'",
    "Make content more specific to the actual announcement rather than generic company messaging",
    "Focus on the concrete benefits and features mentioned in the request"
  ],
  critical: "Content must directly address the specific pet wellness platform launch, not generic company updates"
}</pre>
        </div>

        <h3>3.2 Revision Prompt Construction</h3>
        <div class="code-block">
<pre>// From src/prompts.js - genTemplate_revise()
{
  system: `You are a Lemonade copywriter. Voice: friendly, clear, compassionate; airy, concise.
Prefer contractions. Avoid emoji and filler. Avoid heavy insurance jargon; keep facts accurate.
TRAITS: witty(0.2), empathetic(0.5), clear(1).
LEXICON PREFER: AI-native, automation, instant, instant everything, transparent pricing, Giveback, community, zero paperwork, digital insurer, transparent pricing, customers, community
LEXICON AVOID: sign up, join us, try now, buy now, emoji, lol, btw, pls, u, thx
GUARDS:
- Return ONLY the final text. No prefaces like "Here is...", "Here's...", "Below is...", "Internal comms announcement:", "Press release:".
- No labels (Task:, Output:, Draft:).
- No code fences or markdown headings.`,

  user: `TASK: Revise the text to improve TRS while maintaining relevance to the original request.
TYPE: Press Release
FORMAT RULES:
- CRITICAL: Maintain the specific content from HEADLINE and KEY MESSAGE
- Do NOT drift away from the original announcement details
- Keep factual tone, avoid generic insurance marketing language
- Ensure the response directly addresses the specific news being announced

ORIGINAL REQUEST:
HEADLINE: Lemonade Launches AI-Powered Pet Wellness Platform
KEY MESSAGE: New platform provides instant health assessments and personalized care recommendations for pets
AUDIENCE: customer

CURRENT TEXT TO IMPROVE:
"""
Lemonade is excited to announce the launch of our new AI-powered pet wellness platform. This innovative solution brings instant health assessments and personalized care recommendations to pet owners everywhere.
"""

FIXES TO APPLY:
  1. Include more specific keywords from headline: 'AI-Powered Pet Wellness Platform'
  2. Incorporate key message details: 'instant health assessments' and 'personalized care recommendations'
  3. Make content more specific to the actual announcement rather than generic company messaging
  4. Focus on the concrete benefits and features mentioned in the request

CRITICAL INSTRUCTIONS:
- IMPROVE the existing text based on the TRS feedback
- Do NOT change the topic or subject matter
- Maintain relevance to the original request (see above)
- Keep the same core message but fix the specific issues identified
- Do NOT generate completely new content
- Do NOT generate content for multiple channels

VOICE & EXAMPLES (for style, not content):
• pr-update-customer-0001 — We're rolling out faster claim decisions—powered by our AI—so more customers get paid in minutes, with zero paperwork.
• pr-update-customer-0002 — Pet Wellness is arriving in more EU countries, bringing simpler care and instant everything to your furry family.
• pr-giveback-customer-0001 — Thanks to our community, we donated over $2M this year to nonprofits our customers care about—part of our annual Giveback.
OUTPUT: Only the final text (no preface, no labels, no fences).`
}</pre>
        </div>

        <h3>3.3 LLM Revision Response</h3>
        <div class="code-block">
<pre>// Revised content (IMPROVED)
"Lemonade launches its AI-Powered Pet Wellness Platform, delivering instant health assessments and personalized care recommendations for pets. The platform uses advanced AI to provide immediate insights into pet health and wellness needs."</pre>
        </div>

        <h3>3.4 TRS Scoring (Attempt #2)</h3>
        <div class="code-block">
<pre>{
  rules: 40, // +15 improvement: now has 3+ keyword matches
  lexicon: 20, // +0: maintained preferred word usage
  critic: 36, // +8 improvement: more specific and relevant
  total: 96, // PASS (above 80 threshold)
  verdict: "pass"
}</pre>
        </div>

        <div class="success">
            <h4>Detailed TRS Breakdown:</h4>
            <ul>
                <li><strong>Rules (40 max):</strong> 40/40 ✅
                    <ul>
                        <li>Base: 40</li>
                        <li>Keyword penalty: 0 (now has 3+ matches: "AI-Powered", "Pet", "Wellness", "Platform", "instant", "health", "assessments", "personalized", "care", "recommendations")</li>
                        <li>Generic content penalty: 0 (no generic phrases)</li>
                    </ul>
                </li>
                <li><strong>Lexicon (20 max):</strong> 20/20 ✅
                    <ul>
                        <li>Preferred words: +20 (AI-Powered, instant, personalized, platform)</li>
                        <li>Banned words: 0 (no banned words)</li>
                    </ul>
                </li>
                <li><strong>Critic (40 max):</strong> 36/40 ✅
                    <ul>
                        <li>Professional tone: +10</li>
                        <li>Content relevance: +14 (highly relevant to specific announcement)</li>
                        <li>Specificity: +12 (includes concrete details and features)</li>
                    </ul>
                </li>
            </ul>
        </div>

        <h2>Stage 4: Final Result</h2>

        <h3>4.1 Best Result Selection</h3>
        <div class="code-block">
<pre>// From src/orchestrator.js - tracks best TRS across attempts
{
  attempt: 2,
  trs: 96,
  verdict: "pass",
  text: "Lemonade launches its AI-Powered Pet Wellness Platform, delivering instant health assessments and personalized care recommendations for pets. The platform uses advanced AI to provide immediate insights into pet health and wellness needs.",
  latency_ms: 2847,
  total_attempts: 2
}</pre>
        </div>

        <h3>4.2 Performance Metrics</h3>
        <div class="metrics">
            <div class="metric-card">
                <div class="metric-value">2847ms</div>
                <div class="metric-label">Total Duration</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">2</div>
                <div class="metric-label">Attempts Made</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">+23</div>
                <div class="metric-label">TRS Improvement</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">PASS</div>
                <div class="metric-label">Final Verdict</div>
            </div>
        </div>

        <h2>Content Comparison</h2>
        <div class="comparison">
            <div class="comparison-item">
                <h4>Attempt #1 (FAILED)</h4>
                <div class="warning">
                    <p><strong>TRS Score:</strong> 73/100 (Borderline)</p>
                    <p><strong>Issues:</strong></p>
                    <ul>
                        <li>Only 1 keyword match</li>
                        <li>Generic company messaging</li>
                        <li>Lacks specific details</li>
                    </ul>
                </div>
                <div class="code-block">
<pre>"Lemonade is excited to announce the launch of our new AI-powered pet wellness platform. This innovative solution brings instant health assessments and personalized care recommendations to pet owners everywhere."</pre>
                </div>
            </div>
            <div class="comparison-item">
                <h4>Attempt #2 (PASSED)</h4>
                <div class="success">
                    <p><strong>TRS Score:</strong> 96/100 (Pass)</p>
                    <p><strong>Improvements:</strong></p>
                    <ul>
                        <li>8+ keyword matches</li>
                        <li>Specific platform details</li>
                        <li>Concrete features mentioned</li>
                    </ul>
                </div>
                <div class="code-block">
<pre>"Lemonade launches its AI-Powered Pet Wellness Platform, delivering instant health assessments and personalized care recommendations for pets. The platform uses advanced AI to provide immediate insights into pet health and wellness needs."</pre>
                </div>
            </div>
        </div>

        <h2>Key Insights from This Flow</h2>
        
        <div class="insight-grid">
            <div class="insight-card">
                <h4>1. Policy-Driven Reference Selection</h4>
                <p>The system automatically selected 3 customer-focused examples from the corpus based on the audience parameter, ensuring the generated content matches the expected tone and style.</p>
            </div>
            
            <div class="insight-card">
                <h4>2. Structured Prompt Engineering</h4>
                <p>The prompt template systematically combines system instructions, task-specific requirements, corpus examples for style guidance, and explicit guards against unwanted output formats.</p>
            </div>
            
            <div class="insight-card">
                <h4>3. TRS Scoring Precision</h4>
                <p>The scoring system identified specific issues in rules (keyword matching), lexicon (preferred/banned word usage), and critic (content relevance and specificity evaluation).</p>
            </div>
            
            <div class="insight-card">
                <h4>4. Smart Retry Logic</h4>
                <p>The retry mechanism generated specific, actionable feedback, maintained context from the original request, prevented content drift through explicit instructions, and achieved significant improvement (+23 points) in just one revision.</p>
            </div>
            
            <div class="insight-card">
                <h4>5. Content Quality Improvement</h4>
                <p>The revision successfully increased keyword inclusion from 1 to 8+ matches, enhanced specificity by focusing on concrete platform features, maintained professional tone while improving relevance, and achieved passing TRS score through targeted improvements.</p>
            </div>
        </div>

        <div class="highlight">
            <p><strong>This flow demonstrates how the system's structured approach to content generation, combined with intelligent feedback and retry mechanisms, can transform a borderline result into a high-quality, passing output.</strong></p>
        </div>
    </div>
</body>
</html>
